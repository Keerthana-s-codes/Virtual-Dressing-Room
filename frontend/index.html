<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Try Vibe — AI Virtual Dressing Room</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --primary:#ff7a00; --accent:#6b46ff; --bg:#f5f7fb; --card:#fff; --muted:#6b7280; --dark:#0b1220;
      --shadow: 0 8px 28px rgba(15,23,36,0.06);
      --glass: rgba(255,255,255,0.7);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Arial;color:var(--dark)}
    a{color:inherit;text-decoration:none}
    header.site-header{background:#fff;padding:16px 40px;border-bottom:1px solid rgba(0,0,0,0.04);display:flex;align-items:center;gap:18px;position:sticky;top:0;z-index:40}
    .logo{display:flex;align-items:center;gap:12px}
    .badge{background:var(--primary);color:#fff;padding:8px 12px;border-radius:10px;font-weight:800}
    .search{flex:1;display:flex;align-items:center;gap:8px;background:#fff;padding:8px;border-radius:10px;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,0.03)}
    .search input{flex:1;border:0;outline:none;padding:8px;font-size:15px}
    .header-actions{display:flex;gap:10px;align-items:center}
    .icon-btn{background:#fff;border:0;padding:10px 12px;border-radius:10px;cursor:pointer;box-shadow:var(--shadow)}
    main.container{max-width:1400px;margin:24px auto;padding:0 18px;width:calc(100% - 36px)}
    .hero{background:linear-gradient(90deg, rgba(107,70,255,0.06), rgba(255,122,0,0.03)); border-radius:12px;padding:28px;display:flex;gap:18px;align-items:center}
    .hero-left{flex:1}
    .hero h1{margin:0;font-size:36px}
    .hero p{color:var(--muted);margin:8px 0 0}
    .panel-row{display:flex;gap:18px;margin-top:18px}
    .panel{background:var(--card);padding:16px;border-radius:12px;box-shadow:var(--shadow);flex:1}
    .catalog{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:20px;margin-top:20px}
    .product{background:var(--card);padding:12px;border-radius:12px;box-shadow:var(--shadow);display:flex;flex-direction:column}
    .thumb{width:100%;height:260px;object-fit:cover;border-radius:10px;background:#fafafa}
    .meta{color:var(--muted);font-size:13px}
    .product .actions{display:flex;gap:10px;margin-top:12px}
    .btn{background:var(--accent);color:#fff;padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .btn.secondary{background:#fff;color:var(--accent);border:1px solid rgba(0,0,0,0.06)}
    .rating{display:flex;align-items:center;gap:8px;color:var(--primary);font-weight:700}
    /* Try modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(5,10,20,0.45);display:none;align-items:center;justify-content:center;z-index:90}
    .modal{width:94%;max-width:1100px;background:var(--card);padding:18px;border-radius:12px;display:flex;gap:18px;box-shadow:var(--shadow)}
    .try-left{flex:1}
    .try-right{width:420px;display:flex;flex-direction:column;gap:12px}
    input[type=file]{padding:8px;border-radius:8px;border:1px solid #eee}
    .small-muted{color:var(--muted);font-size:13px}
    /* recommendation list */
    .recs{display:flex;flex-direction:column;gap:10px}
    .rec-item{display:flex;gap:10px;align-items:center;padding:8px;border-radius:8px;background:linear-gradient(180deg,#fff,#fbfbfd);border:1px solid rgba(0,0,0,0.03)}
    .rec-thumb{width:60px;height:60px;border-radius:8px;background:#eee;object-fit:cover}
    /* preview panel */
    .preview-box{background:#fbfcff;border-radius:10px;padding:12px;text-align:center;display:flex;align-items:center;justify-content:center;min-height:360px}
    .preview-box img{max-width:100%;max-height:360px;border-radius:8px;object-fit:contain}
    /* Skin & season visual */
    .swatch{width:64px;height:64px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);box-shadow:0 6px 18px rgba(10,10,20,0.04)}
    .swatch-label{font-size:13px;color:var(--muted);margin-top:6px;text-align:center}
    .skin-result{display:flex;gap:12px;align-items:center}
    .skin-info{display:flex;flex-direction:column;gap:8px}
    /* Personal color card */
    .tone-card{background:linear-gradient(180deg,#fff,#fbfbff);padding:14px;border-radius:12px;border:1px solid rgba(0,0,0,0.04);display:flex;flex-direction:column;align-items:center;min-width:120px}
    .tone-name{font-weight:800;color:var(--accent);font-size:18px}
    .tone-rgb{font-size:12px;color:var(--muted);margin-top:6px}
    /* responsive */
    @media (max-width:900px){
      .panel-row{flex-direction:column}
      .modal{flex-direction:column}
      .try-right{width:100%}
      .preview-box{min-height:240px}
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="logo"><div class="badge">Try Vibe</div><div style="font-size:13px;color:var(--muted)">Virtual Dressing & Shopping</div></div>
    <div class="search" role="search">
      <input id="q" type="search" placeholder="Search products, e.g. jackets, saree, sneakers..." />
      <button onclick="doSearch()" style="background:var(--primary);border-radius:8px;padding:8px 12px;border:0;color:white;cursor:pointer">Search</button>
    </div>
    <div class="header-actions">
      <button class="icon-btn" onclick="openSignModal()" id="signBtn">Sign in</button>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <div class="hero-left">
        <h1>REFLECT YOUR PERSONAL STYLE</h1>
        <p>Try clothes on your photo instantly. Click Try On and upload a full-body photo — our backend will use OOT-diffusion or a local fallback to return a fitted result.</p>
      </div>
      <div class="hero-right">
        <img src="./Poster.png" alt="banner" style="width:320px;height:140px;object-fit:cover;border-radius:10px;border:1px solid #eee" onerror="this.style.display='none'"/>
      </div>
    </section>

    <!-- Skin + Seasonal row (side-by-side) -->
    <div class="panel-row" style="margin-top:20px">
      <div class="panel">
        <!-- Changed title here to Personal Color -->
        <h3 style="margin-top:0">Personal Color</h3>
        <p class="small-muted">Upload a face photo to get your personal tone and a helpful color palette.</p>
        <div style="display:flex;gap:12px;align-items:center;margin-top:12px">
          <input id="skinFile" type="file" accept="image/*"/>
          <button class="btn" onclick="doSkin()">Analyze</button>
          <div id="skinResultBox" style="flex:1"></div>
        </div>
      </div>

      <div class="panel">
        <h3 style="margin-top:0">Seasonal Picks</h3>
        <p class="small-muted">Enter a city (optional) for local seasonal outfit suggestions, or let us guess from the month.</p>
        <div style="display:flex;gap:12px;align-items:center;margin-top:12px">
          <input id="city" placeholder="City (optional)" style="padding:8px;border-radius:8px;border:1px solid #eee;flex:1"/>
          <button class="btn" onclick="loadSeason()">Show Picks</button>
        </div>
      </div>
    </div>

    <!-- Catalog grid -->
    <div id="catalogGrid" class="catalog"></div>

  </main>

  <!-- Try On Modal (recommendations left, preview right) -->
  <div id="tryModal" class="modal-backdrop">
    <div class="modal">
      <div class="try-left">
        <h3 id="modalItemName">Try On</h3>
        <label class="small-muted">Choose full-body image (JPEG/PNG)</label><br/>
        <input id="fullFile" type="file" accept="image/*" /><br/><br/>
        <div style="display:flex;gap:10px">
          <button class="btn" onclick="uploadTryOn()">Try Now</button>
          <!-- Try button inside modal that redirects to Hugging Face Kolors page -->
          <button class="btn secondary" onclick="goToKolors()">Try</button>
          <button class="btn secondary" onclick="closeTryModal()">Cancel</button>
        </div>

        <!-- recommendations: left column -->
        <div id="recInModal" style="margin-top:16px">
          <h4 style="margin:8px 0">Recommendations</h4>
          <div class="recs" id="recList">
            <!-- filled dynamically -->
          </div>
        </div>
      </div>

      <div class="try-right">
        <div class="preview-box">
          <!-- sample preview image (local path present in your environment) -->
          <img id="preview" src="/mnt/data/67fb3582-fe2b-4035-a174-05af3838d4cf.png" alt="preview" />
        </div>
        <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
          <div class="small-muted">Result preview</div>
          <div style="font-size:13px;color:var(--muted)">Tip: upload a full-body photo for best results.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sign modal (simple) -->
  <div id="signModal" class="modal-backdrop" style="display:none">
    <div class="modal" style="max-width:480px;flex-direction:column">
      <h3 style="margin:0 0 10px 0">Sign in / Create account</h3>
      <input id="signinEmail" placeholder="Email" style="padding:10px;border-radius:8px;border:1px solid #eee;margin-bottom:8px"/>
      <input id="signinPassword" placeholder="Password" type="password" style="padding:10px;border-radius:8px;border:1px solid #eee;margin-bottom:12px"/>
      <div style="display:flex;gap:8px">
        <button class="btn" onclick="doSignIn()">Sign in</button>
        <button class="btn secondary" onclick="doSignUp()">Create account</button>
        <button class="btn secondary" onclick="closeSignModal()">Close</button>
      </div>
    </div>
  </div>

<script>
/* Config */
const API = "http://127.0.0.1:8000";

/* Catalog load & render */
let catalog = [];
async function loadCatalog(){
  try{
    const res = await fetch(API + "/catalog");
    if(!res.ok) throw new Error("catalog fetch failed: " + res.status);
    const j = await res.json();
    catalog = j.items || [];
    renderCatalog(catalog);
  }catch(e){
    console.error("catalog failed", e);
    document.getElementById("catalogGrid").innerHTML = "<div style='grid-column:1/-1;padding:18px;color:#b00'>Failed to load catalog — backend running?</div>";
  }
}

function renderCatalog(items){
  const grid = document.getElementById("catalogGrid");
  grid.innerHTML = "";
  items.forEach(it=>{
    const el = document.createElement("div");
    el.className = "product";
    const rating = (it.rating || 4.5).toFixed(1);
    const reviews = it.reviews || Math.floor(50 + Math.random()*400);
    el.innerHTML = `
      <img class="thumb" src="${API + it.thumb}" alt="${it.name}" onerror="this.style.opacity=0.6"/>
      <h4 style="margin:10px 0 4px 0">${it.name}</h4>
      <div class="meta">${it.type || ''} • ${it.color || ''}</div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-top:10px">
        <div class="rating">★ ${rating} <span style="color:var(--muted);font-weight:400;margin-left:6px">(${reviews} reviews)</span></div>
        <div style="text-align:right">
          <div style="font-weight:800">₹${it.price || (499 + Math.floor(Math.random()*3000))}</div>
          <div style="margin-top:8px" class="actions">
            <button class="btn secondary" onclick="viewOutfit('${it.id}')">View Outfit</button>
            <button class="btn" onclick="openTryModal('${it.id}')">Try On</button>
          </div>
        </div>
      </div>
    `;
    grid.appendChild(el);
  });
}

/* Try On modal */
let currentItem = null;
function openTryModal(id){
  currentItem = catalog.find(x => x.id === id);
  document.getElementById("modalItemName").innerText = currentItem ? currentItem.name : "Try On";
  document.getElementById("preview").src = "./Preview.jpg";
  document.getElementById("fullFile").value = "";
  document.getElementById("tryModal").style.display = "flex";
  // populate rec list with item.recommend (if available)
  const recContainer = document.getElementById("recList");
  recContainer.innerHTML = "";
  const recs = (currentItem && currentItem.recommend) ? currentItem.recommend : (currentItem ? currentItem.recommendations : []);
  if(Array.isArray(recs) && recs.length){
    recs.forEach(rid=>{
      const recItem = catalog.find(x=>x.id===rid) || {thumb:'/mnt/data/67fb3582-fe2b-4035-a174-05af3838d4cf.png', name:rid};
      const div = document.createElement('div');
      div.className = 'rec-item';
      div.innerHTML = `<img class="rec-thumb" src="${API + (recItem.thumb||recItem.thumb)}" onerror="this.style.opacity=0.6"/><div>${recItem.name||rid}</div>`;
      recContainer.appendChild(div);
    });
  } else {
    for(let i=0;i<3;i++){
      const div = document.createElement('div');
      div.className = 'rec-item';
      div.innerHTML = `<img class="rec-thumb" src="/mnt/data/67fb3582-fe2b-4035-a174-05af3838d4cf.png" /><div>Accessory ${i+1}</div>`;
      recContainer.appendChild(div);
    }
  }
}
function closeTryModal(){ document.getElementById("tryModal").style.display = "none"; }

/* Redirect to the Hugging Face Kolors Virtual Try-On page */
function goToKolors(){
  window.location.href = "https://huggingface.co/spaces/Kwai-Kolors/Kolors-Virtual-Try-On";
}

async function uploadTryOn(){
  const fileEl = document.getElementById("fullFile");
  const f = fileEl.files[0];
  if(!f){ alert("Please choose a full-body image"); return; }
  const form = new FormData();
  form.append("image", f);
  form.append("item_id", currentItem.id);
  try{
    const resp = await fetch(API + "/try_on", { method: "POST", body: form });
    const j = await resp.json();
    if(j.error){ alert("Try on failed: " + j.error); return; }
    const url = API + j.result_image;
    document.getElementById("preview").src = url;
    // update recommendations on left (compact)
    const rec = document.getElementById("recList");
    rec.innerHTML = "";
    (j.recommendations || []).forEach(r=>{
      const div = document.createElement('div');
      div.className = 'rec-item';
      div.innerHTML = `<img class="rec-thumb" src="${API + (r.thumb||'')}" onerror="this.style.opacity=0.6"/><div>${r.name||r.id}</div>`;
      rec.appendChild(div);
    });
  }catch(e){
    console.error(e);
    alert("Server or network error. Is backend running?");
  }
}

/* View outfit (open outfit image in new tab) */
function viewOutfit(id){
  const it = catalog.find(x=>x.id===id);
  if(!it || !it.outfit_png) return alert("Outfit image not available");
  window.open(API + it.outfit_png, "_blank");
}

/* Personal Color (was "Skin analyzer") */
async function doSkin(){
  const f = document.getElementById("skinFile").files[0];
  if(!f){ alert("Choose a face photo"); return; }
  const form = new FormData(); form.append("image", f);
  try{
    const resp = await fetch(API + "/skin_tone", { method: "POST", body: form });
    const j = await resp.json();
    if(j.error){ alert("Analysis failed: " + j.error); return; }
    const pal = j.palette || [];
    const box = document.getElementById("skinResultBox");
    const toneName = j.label ? j.label.toUpperCase() : "UNKNOWN";
    const rgb = j.skin_rgb ? j.skin_rgb.join(", ") : "";
    // Build a cleaner, attractive Personal Color card - no wheel, no season text
    box.innerHTML = `
      <div style="display:flex;gap:12px;align-items:center">
        <div class="tone-card">
          <div style="font-size:12px;color:var(--muted)">Tone</div>
          <div class="tone-name">${toneName}</div>
          <div class="tone-rgb">${rgb}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;flex:1">
          <div style="display:flex;gap:10px;align-items:center">
            ${pal.slice(0,5).map(h=>`<div style="display:flex;flex-direction:column;align-items:center">
              <div class="swatch" style="background:${h}"></div>
              <div class="swatch-label">${h}</div>
            </div>`).join('')}
          </div>
          <div style="margin-top:8px;color:var(--muted);font-size:13px">If the palette is limited, a general neutral palette is recommended.</div>
        </div>
      </div>
    `;
  }catch(e){
    console.error(e);
    alert("Server or network error. Is backend running?");
  }
}

/* Seasonal picks */
async function loadSeason(){
  const city = document.getElementById("city").value.trim();
  const url = API + "/season_recommend" + (city? "?city=" + encodeURIComponent(city) : "");
  try{
    const resp = await fetch(url);
    const j = await resp.json();
    if(j.items){
      renderCatalog(j.items);
      alert("Showing picks for " + j.season);
    } else {
      alert("Season fetch failed");
    }
  }catch(e){
    console.error(e);
    alert("Season fetch failed — backend?");
  }
}

/* Search */
function doSearch(){
  const q = document.getElementById("q").value.toLowerCase().trim();
  if(!q){ renderCatalog(catalog); return; }
  const filtered = catalog.filter(it => (it.name + " " + (it.tags||[]).join(" ")).toLowerCase().includes(q));
  renderCatalog(filtered);
}

/* Simple demo login/signup (localStorage) */
function openSignModal(){ document.getElementById("signModal").style.display = "flex"; }
function closeSignModal(){ document.getElementById("signModal").style.display = "none"; }
function doSignUp(){ const e=document.getElementById("signinEmail").value; if(!e) return alert("enter email"); localStorage.setItem("tryv_user", e); updateSignButton(); closeSignModal(); alert("Account created"); }
function doSignIn(){ const e=document.getElementById("signinEmail").value; if(!e) return alert("enter email"); localStorage.setItem("tryv_user", e); updateSignButton(); closeSignModal(); alert("Signed in"); }
function updateSignButton(){ const u=localStorage.getItem("tryv_user"); document.getElementById("signBtn").innerText = u? ("Hi " + u.split('@')[0]) : "Sign in"; }

/* Init */
window.addEventListener('load', ()=>{
  loadCatalog();
  updateSignButton();
});
</script>
</body>
</html>
